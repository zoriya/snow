apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kyoo-v5
  namespace: argocd
spec:
  project: default
  destination:
    server: https://kubernetes.default.svc
    namespace: kyoo-next
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
  source:
    repoURL: https://github.com/zoriya/Kyoo
    path: chart
    targetRevision: master
    # repoURL: ghcr.io/zoriya/helm-charts
    # chart: kyoo
    # targetRevision: edge
    helm:
      valuesObject:
        global:
          image:
            tag: edge
            imagePullPolicy: Always
          postgres:
            shared:
              host: kyoo-v5-postgres
          extraEnv:
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: "http://otel-collector.otel.svc:4317"
            - name: OTEL_EXPORTER_OTLP_PROTOCOL
              value: "grpc"
        postgres:
          enabled: true
          persistence:
            size: 16Gi
        kyoo:
          address: https://beta.sdg.moe
          transcoderAcceleration: nvidia
          auth:
            apikeys:
              extra:
                - name: admin
                  existingSecret: admin-apikey
                  apikeyKey: uuid
                  claims: '{"permissions": ["users.read", "users.write", "apikeys.read", "apikeys.write", "users.delete", "core.read", "core.write", "core.play", "scanner.trigger"], "verified": true}'
        traefikproxy:
          traefik:
            image:
              tag: "v3.6.4" # will eventually add this to renovate or swap to subchart
            extraArgs:
              - "--entryPoints.web.address=:80/tcp"
              - "--entryPoints.websecure.address=:443/tcp"
              - "--entryPoints.web.forwardedHeaders.insecure=true"
              - "--entryPoints.websecure.forwardedHeaders.insecure=true"
              - "--api.dashboard=true"
              - "--api.insecure=true"
              - "--providers.file.filename=/dynamic_config/dynamic_config.yaml"
              # https://doc.traefik.io/traefik/master/reference/install-configuration/observability/logs-and-accesslogs/
              - "--experimental.otlpLogs=true"
              - "--log.level=INFO"
              - "--log.format=json"
              - "--log.otlp.grpc=true"
              - "--log.otlp.grpc.insecure=true"
              - "--log.otlp.grpc.endpoint=otel-collector.otel.svc::4317"
              - "--accesslog=true"
              - "--accesslog.format=json"
              - "--accesslog.otlp.grpc=true"
              - "--accesslog.otlp.grpc.insecure=true"
              - "--accesslog.otlp.grpc.endpoint=otel-collector.otel.svc::4317"
              # https://doc.traefik.io/traefik/master/reference/install-configuration/observability/metrics/
              - "--metrics.otlp=true"
              - "--metrics.otlp.grpc=true"
              - "--metrics.otlp.grpc.insecure=true"
              - "--metrics.otlp.grpc.endpoint=otel-collector.otel.svc::4317"
              # https://doc.traefik.io/traefik/master/reference/install-configuration/observability/tracing/
              - "--tracing=true"
              - "--tracing.otlp.grpc=true"
              - "--tracing.otlp.grpc.insecure=true"
              - "--tracing.otlp.grpc.endpoint=otel-collector.otel.svc::4317"
        api:
          persistence:
            size: 16Gi
        transcoder:
          runtimeClass: nvidia
        ingress:
          enabled: true
          host: beta.sdg.moe
          ingressClassName: cilium
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt
            acme.cert-manager.io/http01-edit-in-place: "true"
          tls: true
          tlsSecret: kyoo-tls
        extraObjects:
          - apiVersion: v1
            kind: Secret
            metadata:
              name: bigsecret
            type: Opaque
            stringData:
              postgres_user: kyoo_all
              postgres_password: watchSomething4me
              scanner_apikey: scanner-triquarter4u

          - apiVersion: v1
            kind: PersistentVolume
            metadata:
              name: kyoo-v5-medias
            spec:
              accessModes:
                - ReadWriteOnce
              capacity:
                storage: 200Ti
              csi:
                driver: zfs.csi.openebs.io
                fsType: zfs
                volumeAttributes:
                  openebs.io/poolname: ocean
                volumeHandle: "medias"
              persistentVolumeReclaimPolicy: Retain
          - apiVersion: v1
            kind: PersistentVolumeClaim
            metadata:
              name: media
            spec:
              storageClassName: ""
              volumeName: kyoo-v5-medias
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 200Ti

          - apiVersion: external-secrets.io/v1
            kind: ExternalSecret
            metadata:
              name: admin-apikey
            spec:
              refreshPolicy: CreatedOnce
              dataFrom:
                - sourceRef:
                    generatorRef:
                      apiVersion: generators.external-secrets.io/v1alpha1
                      kind: ClusterGenerator
                      name: uuid
